{% extends "base.html" %}

{% block title %}Dashboard - Stockton Esports{% endblock %}

{% block extra_css %}
<!-- Import external CSS file(s) -->
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard-base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='tabs.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='modals.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='admin-panel.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='teams.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='teams-sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='discord.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='communities.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='events.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='updateProfile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='scheduled-events.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='teamstats.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='vods.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='seasons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='leagues.css') }}">

<!-- Import Calendar CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='calendar.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <p>Welcome back, {{ user.firstname }}! Here's what's happening with your esports journey.</p>
    </div>

    <!-- Mobile Tab Dropdown -->
    <select class="tab-dropdown" id="tabDropdown">
        <option value="calendar">üìÖ Calendar</option>
        <option value="profile">üë§ Profile</option>
        <option value="rosters">üë• Communities</option>
        <option value="events">üìÜ Events</option>
        <option value="teams">üéÆ Teams</option>
        {% if user.is_admin or user.is_developer %}
        <option value="admin">üõ°Ô∏è Admin</option>
        {% endif %}
    </select>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="calendar">
            <i class="fa-regular fa-calendar tab-icon"></i>
            Calendar
        </button>
        <button class="tab-button" data-tab="profile">
            <i class="fa-regular fa-user tab-icon"></i>
            Profile
        </button>
        <button class="tab-button" data-tab="rosters">
            <i class="fa-solid fa-users tab-icon"></i>
            Communities
        </button>
        <button class="tab-button" data-tab="events">
            <i class="fa-regular fa-calendar-days tab-icon"></i>
            Events
        </button>
        <button class="tab-button" data-tab="teams">
            <i class="fa-solid fa-gamepad tab-icon"></i>
            Teams
        </button>
        {% if user.is_admin or user.is_developer %}
        <button class="tab-button" data-tab="admin">
            <i class="fa-solid fa-shield-halved tab-icon"></i>
            Admin
        </button>
        {% endif %}
    </div>

    <!-- Calendar Tab -->
    <div id="calendar" class="tab-content active">
        <div class="calendar-container">
            <!-- Main Calendar Section -->
            <div class="calendar-main">
                <div class="calendar-wrapper">
                    <!-- Calendar Navigation -->
                    <div class="calendar-navigation">
                        <a href="{{ url_for('dashboard', year=prev_year, month=prev_month) }}" class="nav-button">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                        <h1 class="calendar-month-year">{{ month_name }} {{ year }}</h1>
                        <a href="{{ url_for('dashboard', year=next_year, month=next_month) }}" class="nav-button">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>

                    <!-- Days of week header -->
                    <div class="calendar-header">
                        <div class="calendar-day-name">SUN</div>
                        <div class="calendar-day-name">MON</div>
                        <div class="calendar-day-name">TUES</div>
                        <div class="calendar-day-name">WED</div>
                        <div class="calendar-day-name">THURS</div>
                        <div class="calendar-day-name">FRI</div>
                        <div class="calendar-day-name">SAT</div>
                    </div>

                    <!-- Calendar grid -->
                    <div class="calendar-grid">
                        {% for week in month_calendar %}
                            {% for day in week %}
                                {% if day == 0 %}
                                    <div class="calendar-cell empty"></div>
                                {% else %}
                                    {% set day_date = '%04d-%02d-%02d'|format(year, month, day) %}
                                    {% set is_today = (day_date == today_str) %}

                                    <div class="calendar-cell {% if is_today %}today{% endif %}">
                                        <div class="day-number">{{ day }}</div>

                                        <div class="events-container">
                                            {% if day_date in events_by_date %}
                                                {% set day_events = events_by_date[day_date] %}

                                                {% for event in day_events[:3] %}
                                                    <div class="event-link" onclick="openEventModal({{ event.id }})">
                                                        <div class="event {{ event.event_type|lower }} {% if event.is_scheduled %}scheduled-event{% endif %}"
                                                             data-event-type="{{ event.event_type|lower }}"
                                                             {% if event.is_scheduled %}data-scheduled="true" data-schedule-id="{{ event.schedule_id }}"{% endif %}
                                                             title="Click to view details"
                                                             {% if not event.time %}class="all-day"{% endif %}>
                                                            <div class="event-title">{{ event.title }}</div>
                                                            {% if event.time %}
                                                                <div class="event-time">{{ event.time }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endfor %}

                                                {% if day_events|length > 3 %}
                                                    <div class="event-overflow"
                                                         onclick="openDayModal('{{ day_date }}', '{{ month_name }} {{ day }}, {{ year }}')"
                                                         style="cursor: pointer; color: var(--stockton-blue); text-decoration: underline;">
                                                        +{{ day_events|length - 3 }} more
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>

                    <!-- Calendar Footer -->
                    <div class="calendar-footer">
                        <a href="{{ url_for('dashboard') }}" class="today-button">
                            <i class="fas fa-calendar-day"></i> Jump to Today
                        </a>
                    </div>
                </div>
            </div>

            <!-- Sidebar with Legend -->
            <div class="calendar-sidebar">
                <!-- Event Type Legend Card -->
                <div class="sidebar-card">
                    <h3><i class="fas fa-palette"></i> Event Types</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color tournament"></div>
                            <span class="legend-label">Tournament</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color match"></div>
                            <span class="legend-label">Match</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color practice"></div>
                            <span class="legend-label">Practice</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color event"></div>
                            <span class="legend-label">Event</span>
                        </div>
                        <!-- ADD THIS -->
                        <div class="legend-item">
                            <div class="legend-color misc"></div>
                            <span class="legend-label">Misc</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color scheduled-indicator"></div>
                            <span class="legend-label">Recurring/Scheduled</span>
                        </div>
                    </div>
                </div>
                <!-- Today's Events Card -->
                <div class="sidebar-card">
                    <h3><i class="fas fa-calendar-day"></i> Today's Events</h3>
                    {% set today_events = events_by_date.get(today_str, []) %}
                    {% if today_events %}
                        <div class="today-events-list">
                            {% for event in today_events %}
                                <div class="today-event-item" onclick="openEventModal({{ event.id }})">
                                    <div class="today-event-time">
                                        {% if event.time %}
                                            <i class="fas fa-clock"></i> {{ event.time }}
                                        {% else %}
                                            <i class="fas fa-calendar"></i> All Day
                                        {% endif %}
                                    </div>
                                    <div class="today-event-title">{{ event.title }}</div>
                                    <span class="today-event-type {{ event.event_type|lower }}">{{ event.event_type }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                            No events scheduled for today.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="tab-content">
        <div class="content-card">
            <div class="card-header">
                <h2>Your Profile</h2>
                <p>View and manage your account information</p>
            </div>

            <div class="profile-grid">
                <div class="profile-avatar">
                    <div class="avatar-container">
                        {% if user.profile_picture %}
                            <img src="{{ url_for('static', filename='uploads/avatars/' + user.profile_picture) }}"
                                alt="Profile Picture"
                                style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        {% else %}
                            {{ user.firstname[0] }}{{ user.lastname[0] }}
                        {% endif %}
                    </div>
                    <button class="btn btn-secondary" onclick="openAvatarModal()">Change Avatar</button>
                </div>

                <div class="profile-info">
                    <div class="info-row">
                        <div class="info-label">Full Name</div>
                        <div class="info-value">{{ user.firstname }} {{ user.lastname }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Username</div>
                        <div class="info-value">{{ user.username }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Email</div>
                        <div class="info-value">{{ user.email }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Account Status</div>
                        <div class="info-value">
                            {% if is_verified %}
                                <span style="color: var(--stockton-blue);">‚úì Verified</span>
                            {% else %}
                                <span style="color: var(--stockton-yellow);">‚ö† Pending Verification</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Member Since</div>
                        <div class="info-value">{{ user.date.strftime('%B %d, %Y') }}</div>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <button class="btn btn-primary">Edit Profile</button>
                <button class="btn btn-secondary">Change Password</button>
            </div>
        </div>

            <!-- NEW: Notification Settings Card -->
            <div class="content-card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2>Notification Settings</h2>
                    <p>Configure how you receive event reminders</p>
                </div>

                <form id="notificationSettingsForm" class="notification-form">
                    <div class="notification-toggle">
                        <div class="toggle-info">
                            <h3>Enable Event Notifications</h3>
                            <p>Receive email reminders for upcoming events</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox"
                                   name="enable_notifications"
                                   id="enableNotifications"
                                   {% if preferences and preferences.enable_notifications %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="notificationOptions"
                         class="notification-options"
                         style="{% if not preferences or not preferences.enable_notifications %}display: none;{% endif %}">

                        <!-- Event Type Filters -->
                        <div class="form-section">
                            <h3>Event Types to Notify</h3>
                            <p class="section-description">Choose which types of events you want to be notified about</p>

                            <div class="event-type-checkboxes">
                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           name="notify_practices"
                                           id="notifyPractices"
                                           {% if not preferences or preferences.notify_practices %}checked{% endif %}>
                                    <span class="checkbox-text">
                                        <i class="fas fa-dumbbell"></i>
                                        <strong>Practices</strong>
                                        <small>Team practice sessions and training</small>
                                    </span>
                                </label>

                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           name="notify_matches"
                                           id="notifyMatches"
                                           {% if not preferences or preferences.notify_matches %}checked{% endif %}>
                                    <span class="checkbox-text">
                                        <i class="fas fa-gamepad"></i>
                                        <strong>Matches</strong>
                                        <small>Regular competitive matches</small>
                                    </span>
                                </label>

                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           name="notify_tournaments"
                                           id="notifyTournaments"
                                           {% if not preferences or preferences.notify_tournaments %}checked{% endif %}>
                                    <span class="checkbox-text">
                                        <i class="fas fa-trophy"></i>
                                        <strong>Tournaments</strong>
                                        <small>Tournament events and competitions</small>
                                    </span>
                                </label>

                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           name="notify_events"
                                           id="notifyEvents"
                                           {% if not preferences or preferences.notify_events %}checked{% endif %}>
                                    <span class="checkbox-text">
                                        <i class="fas fa-calendar-alt"></i>
                                        <strong>General Events</strong>
                                        <small>Team meetings, socials, and other events</small>
                                    </span>
                                </label>

                                <label class="checkbox-label">
                                    <input type="checkbox"
                                           name="notify_misc"
                                           id="notifyMisc"
                                           {% if not preferences or preferences.notify_misc %}checked{% endif %}>
                                    <span class="checkbox-text">
                                        <i class="fas fa-star"></i>
                                        <strong>Miscellaneous</strong>
                                        <small>Team photoshoots, outings, and other activities</small>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Advance Notice</h3>
                            <p class="section-description">How far in advance should we notify you?</p>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="adviceNoticeDays">Days Before</label>
                                    <input type="number"
                                           id="adviceNoticeDays"
                                           name="advance_notice_days"
                                           min="0"
                                           max="30"
                                           value="{% if preferences %}{{ preferences.advance_notice_days }}{% else %}1{% endif %}">
                                </div>

                                <div class="form-group">
                                    <label for="adviceNoticeHours">Hours Before</label>
                                    <input type="number"
                                           id="adviceNoticeHours"
                                           name="advance_notice_hours"
                                           min="0"
                                           max="23"
                                           value="{% if preferences %}{{ preferences.advance_notice_hours }}{% else %}0{% endif %}">
                                </div>
                            </div>

                            <div class="notification-preview">
                                <i class="fas fa-info-circle"></i>
                                <span id="notificationPreview">
                                    You'll be notified
                                    <strong id="previewTime">1 day</strong>
                                    before each event
                                </span>
                            </div>
                        </div>
                    </div>

                    <div id="notificationMessage" class="form-message" style="display: none;"></div>

                    <div class="profile-actions">
                        <button type="submit" class="btn btn-primary">
                            <span id="saveNotifBtnText">Save Notification Settings</span>
                            <i id="saveNotifBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                        </button>
                    </div>
                </form>
            </div>

        <!-- My Communities Section -->
        <div class="content-card" style="margin-top: 2rem;">
            <div class="card-header">
                <h2>My Communities</h2>
                <p>Game communities you've joined</p>
            </div>

            <!-- Loading State -->
            <div id="myCommunitiesLoading" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                <p style="color: var(--text-secondary); margin-top: 1rem;">Loading communities...</p>
            </div>

            <!-- Communities Grid -->
            <div id="myCommunitiesGrid" class="my-communities-grid" style="display: none;"></div>

            <!-- Empty State -->
            <div id="myCommunitiesEmpty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üéÆ</div>
                <h3>No Communities Yet</h3>
                <p>Join game communities from the Communities tab to see them here</p>
            </div>
        </div>

    <!-- ========================================
     DISCORD INTEGRATION CARD
     Add this AFTER the Notification Settings Card
     in your Profile Tab (around line 280)
     ======================================== -->

<div class="content-card" style="margin-top: 2rem;">
    <div class="card-header">
        <h2>Discord Integration</h2>
        <p>Connect your Discord account to enhance your profile</p>
    </div>

    <!-- Loading State -->
    <div id="discordLoading" style="text-align: center; padding: 2rem;">
        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
        <p style="color: var(--text-secondary); margin-top: 1rem;">Loading Discord connection...</p>
    </div>

    <!-- Not Connected State -->
    <div id="discordNotConnected" style="display: none;">
        <div class="empty-state" style="padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">
                <i class="fab fa-discord" style="color: #5865F2;"></i>
            </div>
            <h3>Connect Your Discord Account</h3>
            <p style="max-width: 500px; margin: 1rem auto;">
                Link your Discord account to display your Discord username and profile picture on your esports profile.
            </p>
            <button onclick="connectDiscord()" class="btn btn-primary discord-connect-btn">
                Connect Discord
            </button>
        </div>
    </div>

    <!-- Connected State -->
    <div id="discordConnected" style="display: none;">
        <div class="discord-profile-container">
            <div class="discord-profile-header">
                <div id="discordAvatarContainer" class="discord-avatar-large">
                    <!-- Avatar will be inserted here -->
                </div>
                <div class="discord-profile-info">
                    <h3 id="discordUsername"></h3>

                    <p id="discordConnectedDate">
                        <i class="fas fa-link"></i> Connected on <span id="connectedDateText"></span>
                    </p>
                </div>
            </div>

            <div class="profile-actions discord-actions">
                <button onclick="disconnectDiscord()" class="btn btn-secondary">
                    <i class="fas fa-unlink"></i> Disconnect Discord
                </button>
            </div>


        </div>
    </div>
</div>
<!--DISCLAIMER: BELOW CODE WAS GENERATED USING CLAUDE AI-->
<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Profile</h2>
            <span class="close" onclick="closeEditProfileModal()">&times;</span>
        </div>

        <form id="editProfileForm" class="modal-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="editFirstName">First Name *</label>
                    <input type="text"
                           id="editFirstName"
                           name="firstname"
                           required
                           value="{{ user.firstname }}">
                </div>

                <div class="form-group">
                    <label for="editLastName">Last Name *</label>
                    <input type="text"
                           id="editLastName"
                           name="lastname"
                           required
                           value="{{ user.lastname }}">
                </div>
            </div>

            <div class="form-group">
                <label for="editUsername">Username *</label>
                <input type="text"
                       id="editUsername"
                       name="username"
                       required
                       value="{{ user.username }}">
                <small>This will be your unique identifier</small>
            </div>

            <!-- Removed editable email field -->
            <div class="form-group">
                <label>Email</label>
                <input type="email"
                       id="editEmail"
                       name="email"
                       value="{{ user.email }}"
                       readonly>
                <small>You cannot change your email address</small>
            </div>

            <div id="editProfileMessage" class="form-message" style="display: none;"></div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <span id="saveProfileBtnText">Save Changes</span>
                    <i id="saveProfileBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Change Password</h2>
            <span class="close" onclick="closeChangePasswordModal()">&times;</span>
        </div>

        <form id="changePasswordForm" class="modal-form">
            <div class="form-group">
                <label for="currentPassword">Current Password *</label>
                <input type="password"
                       id="currentPassword"
                       name="current_password"
                       required>
            </div>

            <div class="form-group">
                <label for="newPassword">New Password *</label>
                <input type="password"
                       id="newPassword"
                       name="new_password"
                       required
                       minlength="8">
                <small>Must be at least 8 characters</small>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm New Password *</label>
                <input type="password"
                       id="confirmPassword"
                       name="confirm_password"
                       required>
            </div>

            <div id="changePasswordMessage" class="form-message" style="display: none;"></div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <span id="changePasswordBtnText">Change Password</span>
                    <i id="changePasswordBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                </button>
            </div>
        </form>
    </div>
</div>
<!--DISCLAIMER: ABOVE CODE WAS GENERATED USING CLAUDE AI-->
        </div>

    <!-- Communities Tab -->
    <div id="rosters" class="tab-content">
        <div class="content-card">
            <div class="card-header">
                <div>
                    <h2>Game Communities</h2>
                    <p>Browse games and join communities</p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="rostersLoading" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                <p style="color: var(--text-secondary); margin-top: 1rem;">Loading games...</p>
            </div>

            <!-- Games Grid -->
            <div id="rostersGrid" style="display: none;">
                <!-- Games will be populated here by JavaScript -->
            </div>

            <!-- Empty State -->
            <div id="rostersEmpty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üéÆ</div>
                <h3>No Games Available</h3>
                <p>Games will appear here once created by administrators</p>
            </div>
        </div>
    </div>

    <!-- Game Details Modal -->
    <div id="gameDetailsModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2 id="gameDetailsModalTitle">Game Details</h2>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <!-- GM Button will be inserted here by JavaScript -->
                    <div id="gmButtonContainer"></div>

                    <button class="modal-close" onclick="closeGameDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Loading Spinner -->
                <div id="gameDetailsLoading" class="loading-spinner" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                    <p style="color: var(--text-secondary); margin-top: 1rem;">Loading game details...</p>
                </div>

                <!-- Game Details Content -->
                <div id="gameDetailsContent" style="display: none;">
                    <div class="game-details-header">
                        <div class="game-details-icon" id="gameDetailsIcon"></div>
                        <div class="game-details-info">
                            <h3 id="gameDetailsTitle"></h3>
                            <p id="gameDetailsDescription"></p>
                        </div>
                    </div>

                    <!-- Game stats row - now includes next scheduled event -->
                    <div class="game-stats-and-event">
                        <div class="game-stats-row">
                            <div class="game-stat-card">
                                <i class="fas fa-users"></i>
                                <div class="game-stat-number" id="gameDetailsMemberCount">0</div>
                                <div class="game-stat-label">Members</div>
                            </div>
                            <div class="game-stat-card">
                                <i class="fas fa-shield-alt"></i>
                                <div class="game-stat-number" id="gameDetailsTeamCount">0</div>
                                <div class="game-stat-label">Teams</div>
                            </div>
                        </div>

                        <!-- Next Scheduled Event Card -->
                        <div id="gameNextScheduledEventContainer" class="game-next-event-container">
                            <!-- Event will be loaded here -->
                        </div>
                    </div>

                    <div class="game-members-section">
                        <h3>Community Members</h3>

                        <!-- Search input FIRST -->
                        <input type="text"
                               id="memberSearch"
                               placeholder="Search members..."
                               onkeyup="filterMembers()"
                               style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 6px; background: var(--dark-bg); border: 1px solid var(--border-color); color: var(--text-primary);">

                        <!-- Members list SECOND -->
                        <div id="gameMembersList" class="members-list">
                            <!-- Members will be populated here -->
                        </div>

                        <!-- Empty state -->
                        <div id="gameNoMembers" class="empty-state-small" style="display: none;">
                            <i class="fas fa-users-slash"></i>
                            <p>No members yet. Be the first to join!</p>
                        </div>
                    </div>

                    <div class="game-details-actions">
                        <button id="gameDetailsJoinBtn" class="btn btn-success" style="display: none;">
                            <i class="fas fa-user-plus"></i> <span>Join Community</span>
                        </button>
                        <button id="gameDetailsLeaveBtn" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-sign-out-alt"></i> <span>Leave Community</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Game Manager Modal -->
    <div id="assignGMModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assign Game Manager</h2>
                <button class="modal-close" onclick="closeAssignGMModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-subtitle">Select a Game Manager to assign to this community</p>

                <!-- Loading State -->
                <div id="gmListLoading" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                    <p style="color: var(--text-secondary); margin-top: 1rem;">Loading Game Managers...</p>
                </div>

                <!-- GM List -->
                <div id="gmListContainer" style="display: none;">
                    <div id="gmList" class="gm-selection-list"></div>
                </div>

                <!-- Empty State -->
                <div id="gmListEmpty" class="empty-state-small" style="display: none;">
                    <i class="fas fa-user-shield"></i>
                    <p>No Game Managers available</p>
                </div>

                <div id="assignGMMessage" class="form-message" style="display: none; margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Events Tab -->
    <div id="events" class="tab-content">
        <div class="content-card">
            <div class="card-header">
                <div>
                    <h2>Events</h2>
                    <p>Manage matches, practices, and community events</p>
                </div>

                <div class="event-header-controls">
                    <!-- Filter Controls Container - NO MORE ROWS, direct children -->
                    <div class="event-filters-container">
                        <!-- Column 1, Row 1 -->
                        <div class="event-filter-dropdown">
                            <label for="eventFilter">Filter by:</label>
                            <select id="eventFilter" onchange="filterEvents()">
                                <option value="subscribed" {% if not (user.is_admin or user.is_developer or user.is_gm) %}selected{% endif %}>Subscribed Events</option>
                                <option value="all" {% if user.is_admin or user.is_developer or user.is_gm %}selected{% endif %}>All Events</option>
                                <option value="upcoming">Next 7 days</option>
                                <option value="upcoming14">Next 14 days</option>
                                <option value="past30">Last 30 days</option>
                                {% if user.is_admin or user.is_developer or user.is_gm %}
                                <option value="created_by_me">Created by Me</option>
                                <option value="past_season">Past Seasons</option>
                                {% endif %}
                                <option value="type">Type</option>
                                <option value="game">Game</option>
                            </select>
                        </div>

                        <!-- Column 2, Row 1 -->
                        <div class="event-filter-dropdown" id="pastSeasonSecondaryFilterContainer" style="display: none;">
                            <label for="pastSeasonSecondaryFilter">Then by:</label>
                            <select id="pastSeasonSecondaryFilter" onchange="filterEventsByPastSeason()">
                                <option value="all">All Events</option>
                                <option value="created_by_me">Created by Me</option>
                                <option value="type">Type</option>
                                <option value="game">Game</option>
                            </select>
                        </div>

                        <!-- Column 1, Row 2 -->
                        <div class="event-filter-dropdown" id="pastSeasonSelectContainer" style="display: none;">
                            <label for="pastSeasonSelect">Season:</label>
                            <select id="pastSeasonSelect" onchange="handlePastSeasonSelection()">
                                <option value="">Select Past Season</option>
                            </select>
                            <div id="pastSeasonLoadingIndicator" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>

                        <!-- Column 2, Row 2 -->
                        <div class="event-filter-dropdown" id="eventTypeFilterContainer" style="display: none;">
                            <label for="eventTypeFilter">Type:</label>
                            <select id="eventTypeFilter" onchange="handleTypeFilterChange()">
                                <option value="">Select Type</option>
                                <option value="tournament">Tournament</option>
                                <option value="match">Match</option>
                                <option value="practice">Practice</option>
                                <option value="event">Event</option>
                                <option value="misc">Misc</option>
                            </select>
                        </div>

                        <!-- Game Filter - also Column 2, Row 2 (only one shows at a time) -->
                        <div class="event-filter-dropdown" id="gameFilterContainer" style="display: none;">
                            <label for="gameFilter">Game:</label>
                            <select id="gameFilter" onchange="handleGameFilterChange()">
                                <option value="">Select Game</option>
                            </select>
                            <div id="gameFilterLoadingIndicator" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Create Event Button (stays in top right) -->
                    {% if user.is_admin or user.is_developer or user.is_gm %}
                    <button class="btn btn-primary" onclick="openCreateEventModal()">
                        <i class="fas fa-plus"></i> Create Event
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Events Loading State -->
            <div id="eventsLoading" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                <p>Loading events...</p>
            </div>

            <!-- Events Grid Container -->
            <div id="eventsContainer" style="display: none;">
                <!-- Events will be dynamically loaded here -->
            </div>

            <!-- Empty State -->
            <div id="eventsEmptyState" class="events-empty-state" style="display: none;">
                <div class="events-empty-state-icon">üéÆ</div>
                {% if user.is_admin or user.is_developer or user.is_gm %}
                <h3>No Events Found</h3>
                <p>Click "Create Event" to add your first event</p>
                {% else %}
                <h3>No Subscribed Events Found</h3>
                <p>Subscribe to events to see them here, or check back later</p>
                {% endif %}
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteEventConfirmModal" class="delete-confirmation-modal">
            <div class="delete-confirmation-content">
                <div class="delete-confirmation-header">
                    <div class="delete-confirmation-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Delete Event?</h3>
                </div>
                <div class="delete-confirmation-message">
                    Are you sure you want to delete <span id="deleteEventName" class="delete-confirmation-event-name"></span>? This action cannot be undone.
                </div>
                <div class="delete-confirmation-actions">
                    <button class="btn btn-cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
                    <button class="btn btn-confirm-delete" onclick="confirmDeleteEvent()">Delete Event</button>
                </div>
            </div>
        </div>

        <!-- Create Event Modal -->
        {% if user.is_admin or user.is_developer or user.is_gm %}
        <div id="createEventModal" class="modal">
            <div class="modal-content modal-content-large">
                <div class="modal-header">
                    <h2>Create New Event</h2>
                    <button class="modal-close" onclick="closeCreateEventModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="modal-subtitle">Add a new event or match to the calendar</p>

                    <form id="createEventForm" class="event-form-modal">
                        <div class="form-group">
                            <label for="eventName">Event Name</label>
                            <input type="text" id="eventName" name="eventName" placeholder="Enter event name" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventType">Event Type</label>
                                <select id="eventType" name="eventType" required onchange="handleEventTypeChange()">
                                    <option value="">Select type</option>
                                    <option value="Event">Event</option>
                                    <option value="Match">Match</option>
                                    <option value="Practice">Practice</option>
                                    <option value="Tournament">Tournament</option>
                                    <option value="Misc">Misc</option>
                                </select>
                            </div>
                        </div>

                        <!-- Full-width game selection with tags -->
                        <div class="form-group" id="gameFieldGroup">
                            <label for="gameDropdown">Games (Optional)</label>
                            <div style="color: var(--text-secondary); font-size: 0.8125rem; margin-bottom: 0.5rem;">
                                Select games from the dropdown - they'll appear as tags below
                            </div>

                            <!-- Selected games display area -->
                            <div id="selectedGamesContainer" class="selected-games-container">
                                <!-- Selected game tags will appear here -->
                            </div>

                            <!-- Dropdown for selecting games -->
                            <select id="gameDropdown" class="game-dropdown-single">
                                <option value="">+ Add a game</option>
                                <!-- Games will be loaded dynamically via JavaScript -->
                            </select>

                            <div id="gameLoadingIndicator" style="display: none; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                <i class="fas fa-spinner fa-spin"></i> Loading games...
                            </div>

                            <!-- Hidden input to store selected games as JSON -->
                            <input type="hidden" id="selectedGamesInput" name="games" value="[]">
                        </div>

                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate" name="eventDate" required>
                        </div>

                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <div class="form-group" style="margin: 0;">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime" name="startTime" required>
                            </div>

                            <div class="form-group" style="margin: 0;">
                                <label for="endTime">End Time</label>
                                <input type="time" id="endTime" name="endTime" required>
                            </div>

                            <div class="form-group" style="margin: 0; padding-bottom: 0.25rem;">
                                <input type="checkbox" id="allDayEvent" name="allDayEvent" style="display: none;">
                                <button type="button"
                                        id="allDayButton"
                                        class="all-day-toggle-btn"
                                        onclick="toggleAllDayEvent()"
                                        title="Set event to run from 12:00 AM to 11:59 PM">
                                    ALL DAY?
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="eventLocation">Location</label>
                            <select id="eventLocation" name="eventLocation" required>
                                <option value="">Select location</option>
                                <option>Campus Center</option>
                                <option>Campus Center Coffee House</option>
                                <option>Campus Center Event Room</option>
                                <option>D-108</option>
                                <option>Esports Lab (Commons Building 80)</option>
                                <option>Lakeside Lodge</option>
                                <option>Online</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group" id="customLocationGroup" style="display: none;">
                            <label for="customLocation">Custom Location</label>
                            <input type="text" id="customLocation" name="customLocation" placeholder="Enter custom location">
                        </div>

                        <div class="form-group">
                            <label for="eventDescription">Description</label>
                            <textarea id="eventDescription" name="eventDescription" placeholder="Enter event description" rows="4" required></textarea>
                        </div>

                        <div id="formMessage" class="form-message" style="display: none;"></div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeCreateEventModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <span id="submitBtnText">Create Event</span>
                                <i id="submitBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Teams Tab -->
    <div id="teams" class="tab-content">
        <div class="teams-layout">
            <!-- LEFT SIDEBAR: Team List -->
            <aside class="teams-sidebar">
                <div class="teams-sidebar-header">
                    <div class="sidebar-header-top">
                        <h2>Teams</h2>
                        <!-- View Switcher Dropdown (only visible for multi-role users) -->
                        <div id="teamViewSwitcher" class="view-switcher hidden">
                            <select id="teamViewSelect" class="view-switcher-select">
                                <!-- Options populated dynamically by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <p class="teams-subtitle">Select a team to view details</p>
                </div>

                <!-- Loading State -->
                <div id="teamsSidebarLoading" class="sidebar-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading teams...</p>
                </div>

                <!-- Team List -->
                <div id="teamsSidebarList" class="teams-list" style="display: none;">
                    <!-- Teams will be populated here by JavaScript -->
                </div>

                <!-- Empty State -->
                <div id="teamsSidebarEmpty" class="sidebar-empty" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    <p>No teams available</p>
                </div>
            </aside>

            <!-- RIGHT CONTENT: Team Details -->
            <main class="teams-main-content">
                <!-- Welcome State (No team selected) -->
                <div id="teamsWelcomeState" class="teams-welcome">
                    <div class="welcome-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h2>Team Management</h2>
                    <p>Manage teams, players, and performance data</p>
                    <p class="welcome-hint">Select a team from the sidebar to view details</p>
                </div>

                <!-- Team Details Content -->
                <div id="teamsDetailContent" class="teams-detail" style="display: none;">
                    <!-- Team Header -->
                    <div class="team-detail-header">
                        <div class="team-header-left">
                            <div class="team-icon-large">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="team-header-info">
                                <h1 id="teamDetailTitle">Team Name</h1>

                                <!-- Button outside the collapsible container -->
                                <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                    <button id="teamDetailCollapseBtn"
                                            class="team-detail-collapse-btn"
                                            onclick="toggleTeamDetailCollapse()"
                                            title="Toggle details">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>

                                    <!-- Wrap subheaders in collapsible container -->
                                    <div id="teamDetailSubheaders" class="team-detail-subheaders">
                                        <p id="teamDetailGame" style="margin: 0;">Game: Mario Kart</p>
                                        <p id="teamDetailDivision" style="display: none; margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-secondary); font-style: italic;"></p>
                                        <p id="teamDetailLeagues" style="display: none; margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-secondary); font-style: italic;"></p>
                                         <p id="teamDetailSeason" style="display: none; margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-secondary); font-style: italic;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="team-header-actions">
                            <!-- Stack for Add Player and Schedule buttons -->
                            <div class="team-action-buttons-stack">
                                <!-- Add Player button FIRST -->
                                <button id="addPlayerBtn"
                                        class="btn btn-primary"
                                        onclick="openAddTeamMembersModal()"
                                        style="display: none;">
                                    <i class="fas fa-user-plus"></i> Add Player
                                </button>

                                <!-- Schedule button SECOND -->
                                <button id="createScheduleBtn"
                                        class="btn btn-create-schedule"
                                        onclick="openCreateScheduledEventModal()"
                                        style="display: none;">
                                    <i class="fas fa-calendar-plus"></i> Schedule Event
                                </button>
                            </div>

                            <!-- Delete button - vertically centered between the two buttons -->
                            <button id="deleteTeamBtn"
                                    class="btn btn-secondary"
                                    onclick="confirmDeleteSelectedTeam()"
                                    style="display: none;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Team Stats Summary with Next Scheduled Event -->
                    <div class="team-stats-summary">
                        <div class="stat-box">
                            <i class="fas fa-users"></i>
                            <div class="stat-value" id="teamStatMembers">0</div>
                            <div class="stat-label">Members</div>
                        </div>
                        <div class="stat-box">
                            <i class="fas fa-trophy"></i>
                            <div class="stat-value" id="teamStatMaxSize">0</div>
                            <div class="stat-label">Max Size</div>
                        </div>

                        <!-- Next Scheduled Event Container (spans 2 columns) -->
                        <div id="nextScheduledEventContainer">
                            <!-- Next scheduled event will be dynamically loaded here -->
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="team-tabs">
                        <button class="team-tab active" data-team-tab="roster">
                            <i class="fas fa-users"></i> Roster
                        </button>
                        <button class="team-tab" data-team-tab="schedule">
                            <i class="fas fa-calendar-alt"></i> Schedule
                        </button>
                        <button class="team-tab" data-team-tab="stats">
                            <i class="fas fa-chart-bar"></i> Stats
                        </button>
                        <button class="team-tab" data-team-tab="vods">
                            <i class="fas fa-video"></i> VODs
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="team-tab-content">
                        <!-- Roster Tab -->
                        <div id="rosterTabContent" class="team-tab-panel active">
                            <div class="roster-search">
                                <input type="text"
                                       id="rosterSearchInput"
                                       placeholder="Search members..."
                                       onkeyup="filterRosterMembers()">
                            </div>
                            <div id="rosterMembersList" class="roster-members-grid">
                                <!-- Members will be populated here -->
                            </div>
                            <div id="rosterEmpty" class="tab-empty-state" style="display: none;">
                                <i class="fas fa-users-slash"></i>
                                <p>No members on this team yet</p>
                            </div>
                        </div>

                        <!-- Schedule Tab -->
                        <div id="scheduleTabContent" class="team-tab-panel">
                            <div class="schedule-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading schedule...</p>
                            </div>
                        </div>

                        <!-- Stats Tab -->
                        <div id="statsTabContent" class="team-tab-panel">
                            <div class="stats-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading statistics...</p>
                            </div>
                        </div>

                        <!-- VODs Tab -->
                        <div id="vodsTabContent" class="team-tab-panel">
                            <div class="vods-section">
                                <div class="vods-header">
                                    <h3>Team VODs</h3>
                                    {% if user.is_admin or user.is_developer or user.is_gm %}
                                    <button onclick="showAddVodModal()" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Add VOD
                                    </button>
                                    {% endif %}
                                </div>

                                <div class="vods-list" id="vods-list"></div>

                                <div id="vods-empty" class="tab-empty-state" style="display: none;">
                                    <i class="fas fa-video-slash"></i>
                                    <p>No VODs available yet.</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Team Members Modal -->
    <div id="addTeamMembersModal" class="modal">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <h2>Add Members to <span id="addMembersTeamName">Team Name</span></h2>
                <button class="modal-close" onclick="closeAddTeamMembersModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <p class="modal-subtitle">Select members to add to this team</p>

                <!-- Search Bar -->
                <div class="member-search">
                    <input type="text"
                           id="addMemberSearch"
                           placeholder="Search members..."
                           oninput="filterAvailableMembers()">
                </div>

                <!-- Loading State -->
                <div id="availableMembersLoading" class="members-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading available members...</p>
                </div>

                <!-- Empty State -->
                <div id="noAvailableMembers" class="members-empty" style="display: none;">
                    <i class="fas fa-users-slash"></i>
                    <p>No available members to add</p>
                </div>

                <!-- Members List Container (scrollable) -->
                <div id="availableMembersList" class="members-list-container" style="display: none;">
                    <!-- Member items will be populated here by JavaScript -->
                </div>
            </div>

            <!-- Footer with action buttons -->
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddTeamMembersModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="addSelectedMembersToTeam()">
                    <i class="fas fa-user-plus"></i>
                    Add Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Scheduled Event modal -->
    <div id="createScheduledEventModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h2>Create Scheduled Event</h2>
                <button class="modal-close" onclick="closeCreateScheduledEventModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-subtitle">Set up a recurring event for this team</p>

                <form id="createScheduledEventForm" class="event-form-modal">
                    <div class="form-group">
                        <label for="scheduledEventName">Event Name *</label>
                        <input type="text"
                               id="scheduledEventName"
                               name="event_name"
                               placeholder="e.g., Weekly Practice Session"
                               required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduledEventType">Event Type *</label>
                            <select id="scheduledEventType" name="event_type" required>
                                <option value="">Select type</option>
                                <option value="Match">Match</option>
                                <option value="Practice">Practice</option>
                                <option value="Misc">Misc</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="scheduledFrequency">Frequency *</label>
                            <select id="scheduledFrequency" name="frequency" required onchange="handleFrequencyChange()">
                                <option value="">Select frequency</option>
                                <option value="Once">Once</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Biweekly">Biweekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="scheduledLeagueGroup" style="display: none;">
                        <label for="scheduledLeagueSelect">League (Optional)</label>
                        <select id="scheduledLeagueSelect" name="league_id">
                            <option value="">No league (optional)</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <small style="color: var(--text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; display: block;">
                            Select the league this match is part of (if applicable)
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="scheduledLocation">Location *</label>
                        <select id="scheduledLocation" name="location" required>
                            <option value="">Select location</option>
                            <option value="Campus Center">Campus Center</option>
                            <option value="Campus Center Coffee House">Campus Center Coffee House</option>
                            <option value="Campus Center Event Room">Campus Center Event Room</option>
                            <option value="D-108">D-108</option>
                            <option value="Esports Lab (Commons Building 80)">Esports Lab (Commons Building 80)</option>
                            <option value="Lakeside Lodge">Lakeside Lodge</option>
                            <option value="Online">Online</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group" id="scheduledCustomLocationGroup" style="display: none;">
                        <label for="scheduledCustomLocation">Custom Location</label>
                        <input type="text"
                               id="scheduledCustomLocation"
                               name="custom_location"
                               placeholder="Enter custom location">
                    </div>

                    <!-- Day of Week - Hidden when "Once" is selected -->
                    <div class="form-group" id="scheduledDayOfWeekGroup">
                        <label for="scheduledDayOfWeek">Day of Week *</label>
                        <select id="scheduledDayOfWeek" name="day_of_week">
                            <option value="">Select day</option>
                            <option value="6">Sunday</option>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                        </select>
                    </div>

                    <!-- Specific Date - Shown only when "Once" is selected -->
                    <div class="form-group" id="scheduledSpecificDateGroup" style="display: none;">
                        <label for="scheduledSpecificDate">Event Date *</label>
                        <input type="date"
                               id="scheduledSpecificDate"
                               name="specific_date">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduledStartTime">Start Time *</label>
                            <input type="time"
                                   id="scheduledStartTime"
                                   name="start_time"
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="scheduledEndTime">End Time *</label>
                            <input type="time"
                                   id="scheduledEndTime"
                                   name="end_time"
                                   required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scheduledVisibility">Visibility *</label>
                        <select id="scheduledVisibility" name="visibility" required>
                            <option value="">Who can see this?</option>
                            <option value="team" id="visibilityTeamOption">Team Only</option>
                            <option value="game_players" id="visibilityPlayersOption">Players</option>
                            <option value="game_community" id="visibilityCommunityOption">Community Members</option>
                        </select>
                        <small style="color: var(--text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; display: block;">
                            Events will be automatically created on the calendar based on this schedule
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="scheduledEndDate">Schedule End Date *</label>
                        <input type="date"
                               id="scheduledEndDate"
                               name="end_date"
                               required>
                        <small style="color: var(--text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; display: block;">
                            Events will stop being generated after this date
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="scheduledDescription">Description</label>
                        <textarea id="scheduledDescription"
                                  name="description"
                                  placeholder="Event description (optional)"
                                  rows="3"></textarea>
                    </div>

                    <div id="scheduledEventMessage" class="form-message" style="display: none;"></div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateScheduledEventModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-text">Create Schedule</span>
                            <i class="btn-spinner fas fa-spinner fa-spin" style="display: none;"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Details Modal -->
    <div id="scheduleDetailsModal" class="modal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <div class="modal-header-left">
                    <div id="scheduleModalGameIcon" class="schedule-modal-title-game-icon" style="display: none;">
                        <!-- Game icon will be inserted here -->
                    </div>
                    <h2 id="scheduleModalTitle">Schedule Details</h2>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="editScheduleBtn"
                            class="btn-icon-action btn-icon-edit"
                            style="display: none;"
                            title="Edit Schedule">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="deleteScheduleBtn"
                            class="btn-icon-action btn-icon-delete"
                            style="display: none;"
                            title="Delete Schedule">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="modal-close" onclick="closeScheduleModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div id="scheduleModalBody">
                    <!-- Schedule details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tab -->
    {% if user.is_admin or user.is_developer %}
    <div id="admin" class="tab-content">
        <div class="content-card">
            <div class="card-header">
                <div>
                    <h2>Admin Panel</h2>
                    <p>Manage users, roles, and permissions</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="openManageLeaguesModal()">
                        <i class="fas fa-trophy"></i> Manage Leagues
                    </button>
                    <button class="btn btn-primary" onclick="openManageSeasonsModal()">
                        <i class="fas fa-calendar-alt"></i> Manage Seasons
                    </button>
                    <button class="btn btn-primary" onclick="openCreateGameModal()">
                        <i class="fas fa-plus"></i> Create Community
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='/admin/statistics'">
                        <i class="fas fa-chart-line"></i> View Statistics
                    </button>
                </div>
            </div>

            <div class="admin-dashboard">
            <!-- Summary Cards -->
            <div class="admin-summary">
                <div class="summary-card">
                    <div class="summary-icon"><i class="fa-solid fa-users"></i></div>
                    <div>
                        <h3>Total Users</h3>
                        <p>{{ total_users }}</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon"><i class="fa-solid fa-user-check"></i></div>
                    <div>
                        <h3>Active Users</h3>
                        <p>{{ active_users }}</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon"><i class="fa-solid fa-shield-halved"></i></div>
                    <div>
                        <h3>Admins</h3>
                        <p>{{ admins }}</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon"><i class="fa-solid fa-user-tie"></i></div>
                    <div>
                        <h3>Game Managers</h3>
                        <p>{{ gms }}</p>
                    </div>
                </div>
                <!-- Players Card -->
                <div class="summary-card">
                    <div class="summary-icon"><i class="fa-solid fa-gamepad"></i></div>
                    <div>
                        <h3>Players</h3>
                        <p>{{ players }}</p>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div class="admin-content">
                <!-- Left column: user list -->
                <div class="user-list">
                    <h3>User Management</h3>
                    <input type="text" id="userSearch"
                           placeholder="Search users..."
                           class="search-input"
                           oninput="filterUsers()">

                    <ul class="user-items" id="userItems">
                        {% if user_list %}
                            {% for u in user_list %}
                                <li class="user-item"
                                    data-userid="{{ u.id }}"
                                    data-username="{{ u.username }}"
                                    data-firstname="{{ u.firstname }}"
                                    data-lastname="{{ u.lastname }}"
                                    data-email="{{ u.email }}"
                                    data-date="{{ u.date.strftime('%B %d, %Y') }}"
                                    data-active="{{ 'true' if u.is_active else 'false' }}"
                                    data-last-seen="{{ u.last_seen.strftime('%B %d, %Y; %I:%M %p') if u.last_seen else 'Never logged in' }}"
                                    data-is-admin="{{ u.is_admin }}"
                                    data-is-gm="{{ u.is_gm }}"
                                    data-is-player="{{ u.is_player }}"
                                    data-is-developer="{{ u.is_developer }}">
                                    <div>
                                        <strong>{{ u.firstname }} {{ u.lastname }}</strong>
                                        <p>@{{ u.username }} ‚Äî {{ u.email }}</p>
                                        <div style="margin-top: 0.25rem; display: flex; gap: 0.5rem; align-items: center;">

                                            <!-- Role Badges -->
                                            {% if u.is_admin %}
                                            <span class="role-badge admin">Admin</span>
                                            {% endif %}
                                            {% if u.is_developer %}
                                            <span class="role-badge developer">Dev</span>
                                            {% endif %}
                                            {% if u.is_gm %}
                                            <span class="role-badge gm">GM</span>
                                            {% endif %}
                                            {% if u.is_player %}
                                            <span class="role-badge player">Player</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>

                <!-- Right column: user details (initially empty) -->
                <div class="user-details" id="userDetailsPanel">
                    <h3>User Details</h3>
                    <p>Select a user from the list to view details.</p>
                </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Global Modals (Accessible from all tabs) -->

<!-- Day Events Modal -->
<div id="dayEventsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalDayTitle"></h2>
            <button class="modal-close" onclick="closeDayModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modalEventsList">
            <!-- Events will be populated here -->
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2 id="eventDetailsTitle">Event Details</h2>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button id="editEventBtn"
                        class="btn-edit-event"
                        style="display: none;"
                        onclick="toggleEditMode()">
                    <i class="fas fa-edit"></i>
                </button>
                {% if user.is_admin or user.is_developer %}
                <button id="deleteEventBtn"
                        class="btn-delete-event"
                        style="display: none;"
                        onclick="deleteEvent()">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
                <button class="modal-close" onclick="closeEventModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="modal-body" id="eventDetailsBody">
            <!-- Loading spinner -->
            <!-- Edit form will be populated here -->
            <div id="eventEditForm" style="display: none;"></div>
            <div id="eventLoadingSpinner" class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading event details...</p>
            </div>
            <!-- Event details will be populated here -->
            <div id="eventDetailsContent" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Create Game Community Modal -->
<div id="createGameModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Create New Game</h2>
            <button class="modal-close" onclick="closeCreateGameModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Add a new game community to our roster</p>

            <form id="createGameForm" class="event-form-modal" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="gameTitle">Game Title</label>
                    <input type="text" id="gameTitle" name="gameTitle" placeholder="Enter game title" required>
                </div>

                <!-- Division Dropdown -->
                <div class="form-group">
                    <label for="gameDivision">Division *</label>
                    <select id="gameDivision" name="division" required>
                        <option value="">Select division</option>
                        <option value="Strategy">Strategy</option>
                        <option value="Shooter">Shooter</option>
                        <option value="Sports">Sports</option>
                        <option value="Other">Other</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; display: block;">
                        Choose the category this game belongs to
                    </small>
                </div>

                <!-- Image Upload Field -->
                <div class="form-group">
                    <label for="gameImage">Game Icon/Image</label>
                    <input type="file"
                           id="gameImage"
                           name="gameImage"
                           accept="image/png, image/jpeg, image/jpg, image/gif, image/webp">
                    <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
                        <img id="previewImg" style="max-width: 100px; max-height: 100px; border-radius: 8px; border: 2px solid var(--border-color);">
                    </div>
                </div>

                <div class="form-group">
                    <label for="gameDescription">Description</label>
                    <textarea id="gameDescription" name="gameDescription" placeholder="Enter game description" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>Team Size(s)</label>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        Select all applicable team sizes for this game
                    </p>
                    <div class="team-sizes-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem;">
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="1">
                            <span>
                                <i class="fas fa-user checkbox-icon"></i>
                                <div class="checkbox-text">1 Player</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="2">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">2 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="3">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">3 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="4">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">4 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="5">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">5 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="6">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">6 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="7">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">7 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="8">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">8 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="9">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">9 Players</div>
                            </span>
                        </label>
                        <label class="team-size-checkbox">
                            <input type="checkbox" name="teamSize" value="10">
                            <span>
                                <i class="fas fa-users checkbox-icon"></i>
                                <div class="checkbox-text">10 Players</div>
                            </span>
                        </label>
                    </div>
                </div>

                <div id="gameFormMessage" class="form-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateGameModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submitGameBtnText">Create Game</span>
                        <i id="submitGameBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Seasons Modal -->
<div id="manageSeasonsModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Manage Seasons</h2>
            <button class="modal-close" onclick="closeManageSeasonsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Create, edit, and view seasons for organizing events and teams</p>
            <p class="modal-subtitle">Note: Teams cannot be created when no season is active</p>

            <!-- Message Area -->
            <div id="seasonsMessage" class="form-message" style="display: none;"></div>

            <!-- Loading State -->
            <div id="seasonsLoading" style="display: block; text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                <p style="color: var(--text-secondary); margin-top: 1rem;">Loading seasons...</p>
            </div>

            <!-- Content Area -->
            <div id="seasonsContent" style="display: none;">
                <!-- Dynamic content will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Create Team Modal -->
<div id="createTeamModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Create New Team for <span id="teamModalGameTitle"></span></h2>
            <button class="modal-close" onclick="closeCreateTeamModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Add a new team to the roster</p>

            <form id="createTeamForm" class="event-form-modal" enctype="multipart/form-data">
                <input type="hidden" id="gameIDField" name="game_id">

                <div class="form-group">
                    <label for="teamTitle">Team Title</label>
                    <input type="text" id="teamTitle" name="team_title" placeholder="Enter team title" required>
                </div>

                <div class="form-group">
                    <label>Team Size</label>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        Select the applicable team size.
                    </p>
                    <div id="teamSizesContainer" class="team-size-options">
                        <!-- Team size options will be dynamically inserted here -->
                    </div>
                </div>

                <div class="form-group" id="leaguesFieldGroup">
                    <label for="teamLeaguesDropdown">Leagues (Optional)</label>
                    <div style="color: var(--text-secondary); font-size: 0.8125rem; margin-bottom: 0.5rem;">
                        Select leagues this team will compete in - they'll appear as tags below
                    </div>

                    <!-- Selected leagues display area -->
                    <div id="selectedLeaguesContainer" class="selected-games-container">
                        <div style="color: var(--text-secondary); font-size: 0.875rem; padding: 0.5rem;">
                            No leagues selected
                        </div>
                    </div>

                    <!-- Dropdown for selecting leagues -->
                    <select id="teamLeaguesDropdown" class="game-dropdown-single">
                        <option value="">+ Add a league</option>
                        <!-- Leagues will be loaded dynamically via JavaScript -->
                    </select>

                    <div id="teamLeagueLoadingIndicator" style="display: none; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                        <i class="fas fa-spinner fa-spin"></i> Loading leagues...
                    </div>

                    <!-- Hidden input to store selected leagues as JSON -->
                    <input type="hidden" id="selectedLeaguesInput" name="leagues" value="[]">
                </div>

                <div id="teamFormMessage" class="form-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateTeamModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submitTeamBtnText">Create Team</span>
                        <i id="submitTeamBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Record Match Result Modal -->
<div id="recordMatchResultModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Record Match Result</h2>
            <button class="modal-close" onclick="closeRecordResultModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Record the outcome of a past match</p>
            <form id="recordMatchResultForm" class="event-form-modal" onsubmit="submitMatchResult(event)">
                <!-- Match Selection -->
                <div class="form-group">
                    <label for="matchEventSelect">Select Match *</label>
                    <select id="matchEventSelect" name="event_id" required>
                        <option value="">Loading matches...</option>
                    </select>
                    <small style="color: var(--text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; display: block;">
                        Only past matches are shown. Future matches cannot have results recorded yet.
                    </small>
                </div>

                <!-- Result Selection -->
                <div class="form-group">
                    <label>Match Result *</label>
                    <div class="result-options">
                        <label class="result-option result-option-win" data-result="win" onclick="handleResultSelection('win')">
                            <input type="radio" name="matchResult" value="win" required>
                            <div class="result-option-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <span class="result-option-label">WIN</span>
                        </label>

                        <label class="result-option result-option-loss" data-result="loss" onclick="handleResultSelection('loss')">
                            <input type="radio" name="matchResult" value="loss" required>
                            <div class="result-option-icon">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <span class="result-option-label">LOSS</span>
                        </label>
                    </div>
                </div>

                <!-- Optional Notes -->
                <div class="form-group">
                    <label for="matchNotes">Notes (Optional)</label>
                    <textarea id="matchNotes" 
                              name="notes" 
                              rows="3" 
                              placeholder="Add any additional notes about the match..."></textarea>
                    <small style="color: var(--text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; display: block;">
                        e.g., "Close game, went to overtime" or "Dominant performance"
                    </small>
                </div>

                <div id="recordResultMessage" class="form-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRecordResultModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Record Result</span>
                        <i class="btn-spinner fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Match Details Modal -->
<div id="matchDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="matchDetailsTitle">Match Details</h2>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button id="editMatchDetailsBtn"
                        class="btn-icon-action btn-icon-edit"
                        style="display: none;"
                        title="Edit Result">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="modal-close" onclick="closeMatchDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="modal-body">
            <div id="matchDetailsLoading" class="loading-spinner" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                <p style="color: var(--text-secondary); margin-top: 1rem;">Loading match details...</p>
            </div>

            <div id="matchDetailsContent" style="display: none;">
                <!-- Match details will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Team Modal -->
<div id="editTeamModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Edit Team: <span id="editTeamModalTitle">Team Name</span></h2>
            <button class="modal-close" onclick="closeEditTeamModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Update team information</p>

            <form id="editTeamForm" class="event-form-modal">
                <input type="hidden" id="editTeamID" name="team_id">
                <input type="hidden" id="editGameID" name="game_id">

                <div class="form-group">
                    <label for="editTeamTitle">Team Title *</label>
                    <input type="text"
                           id="editTeamTitle"
                           name="team_title"
                           placeholder="Enter team title"
                           required>
                </div>

                <div class="form-group">
                    <label>Team Size *</label>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        Select the team size for this team
                    </p>
                    <div id="editTeamSizesContainer" class="team-size-options">
                        <!-- Radio buttons will be inserted here dynamically -->
                    </div>
                </div>

                <div class="form-group">
                    <label for="editTeamLeaguesDropdown">Leagues (Optional)</label>
                    <div style="color: var(--text-secondary); font-size: 0.8125rem; margin-bottom: 0.5rem;">
                        Select leagues this team will compete in
                    </div>

                    <!-- Selected leagues display area -->
                    <div id="editSelectedLeaguesContainer" class="selected-games-container">
                        <div style="color: var(--text-secondary); font-size: 0.875rem; padding: 0.5rem;">
                            No leagues selected
                        </div>
                    </div>

                    <!-- Dropdown for selecting leagues -->
                    <select id="editTeamLeaguesDropdown" class="game-dropdown-single">
                        <option value="">+ Add a league</option>
                        <!-- Leagues will be loaded dynamically via JavaScript -->
                    </select>

                    <!-- Hidden input to store selected leagues as JSON -->
                    <input type="hidden" id="editSelectedLeaguesInput" name="leagues" value="[]">
                </div>

                <div id="editTeamFormMessage" class="form-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditTeamModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="updateTeamBtnText">Update Team</span>
                        <i id="updateTeamBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Leagues Modal -->
<div id="manageLeaguesModal" class="modal">
    <div class="modal-content modal-content-large">
        <div class="modal-header">
            <h2>Manage Leagues</h2>
            <button class="modal-close" onclick="closeManageLeaguesModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Create, edit, and view leagues for organizing teams and competitions</p>

            <!-- Message Area -->
            <div id="leaguesMessage" class="form-message" style="display: none;"></div>

            <!-- Loading State -->
            <div id="leaguesLoading" style="display: block; text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--stockton-blue);"></i>
                <p style="color: var(--text-secondary); margin-top: 1rem;">Loading leagues...</p>
            </div>

            <!-- Content Area -->
            <div id="leaguesContent" style="display: none;">
                <!-- Dynamic content will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Add VOD Modal -->
<div id="addVodModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Team VOD</h2>
            <button class="modal-close" onclick="closeAddVodModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addVodForm" class="event-form-modal">
                <div class="form-group">
                    <label for="youtube_video_input">YouTube Video URL or ID *</label>
                    <input type="text"
                           id="youtube_video_input"
                           placeholder="https://www.youtube.com/watch?v=... or video ID"
                           required>
                </div>

                <div class="form-group">
                    <label for="opponent">Opponent</label>
                    <input type="text"
                           id="opponent"
                           placeholder="Enter opponent name">
                </div>

                <div class="form-group">
                    <label for="match_date">Match Date</label>
                    <input type="date" id="match_date">
                </div>

                <div id="addVodMessage" class="form-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddVodModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="addVodBtnText">Add VOD</span>
                        <i id="addVodBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- VOD Player Modal -->
<div id="vodPlayerModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="vodPlayerTitle">Video</h2>
            <button class="modal-close" onclick="closeVodPlayerModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="vod-player-container">
                <div id="vodPlayerFrame"></div>
                <div id="vodPlayerInfo">
                    <p id="vodPlayerMeta"></p>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="vod-comments-section">
                <h3>Feedback</h3>

                <!-- Add Comments Form -->
                <div id="vodCommentForm" style="display: none;">
                    <textarea id="commentText" placeholder="Add feedback..."></textarea>
                    <div class="comment-actions">
                        <button onclick="addTimestampToComment()" class="btn btn-secondary">
                            <i class="fas fa-clock"></i> Add Timestamp
                        </button>
                        <button onclick="submitVodComment()" class="btn btn-primary">
                            Post Comment
                        </button>
                    </div>
                    <div id="currentTimestamp" style="display: none; margin-top: 0.5rem; color: var(--stockton-blue);">
                        <i class="fas fa-video"></i> <span id="timestampDisplay"></span>
                    </div>
                </div>

                <!-- Comments List -->
                <div id="vodCommentsList"></div>
            </div>
        </div>
    </div>
</div>
              
<!-- Change Avatar Modal -->
<div id="changeAvatarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Change Profile Picture</h2>
            <button class="modal-close" onclick="closeAvatarModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Upload a custom avatar or sync from Discord</p>

            <form id="uploadAvatarForm" enctype="multipart/form-data" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="avatarFile">Choose Image</label>
                    <input type="file"
                           id="avatarFile"
                           name="avatar"
                           accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                           required>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Accepted formats: PNG, JPG, GIF, WEBP (Max 5MB)
                    </p>
                </div>

                <div id="avatarPreview" style="display: none; text-align: center; margin: 1rem 0;">
                    <img id="avatarPreviewImg"
                         style="max-width: 200px; max-height: 200px; border-radius: 50%; border: 4px solid var(--stockton-blue);">
                </div>

                <div id="avatarUploadMessage" class="form-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAvatarModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="uploadBtnText">Upload Avatar</span>
                        <i id="uploadBtnSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>
            </form>

            <div style="text-align: center; margin: 2rem 0; color: var(--text-secondary); position: relative;">
                <span style="background: var(--background-secondary); padding: 0 1rem; position: relative; z-index: 1;">
                    OR
                </span>
                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border-color); z-index: 0;"></div>
            </div>

            <div style="text-align: center;">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Use your Discord profile picture
                </p>
                <button onclick="syncAvatarFromModal()" class="btn btn-primary" style="background-color: #5865F2 !important;">
                    Sync from Discord
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Cropper Modal -->
<div id="imageCropperModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-crop-alt"></i> Crop Image</h2>
            <button class="modal-close" onclick="closeImageCropper()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-subtitle">Adjust and crop your image to fit perfectly</p>

            <div class="cropper-container-wrapper">
                <img id="imageToCrop" style="max-width: 100%; display: block;">
            </div>

            <div class="crop-controls">
                <button type="button" onclick="cropZoomIn()" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                    <span>Zoom In</span>
                </button>
                <button type="button" onclick="cropZoomOut()" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                    <span>Zoom Out</span>
                </button>
                <button type="button" onclick="cropRotateLeft()" title="Rotate Left">
                    <i class="fas fa-undo"></i>
                    <span>Rotate Left</span>
                </button>
                <button type="button" onclick="cropRotateRight()" title="Rotate Right">
                    <i class="fas fa-redo"></i>
                    <span>Rotate Right</span>
                </button>
                <button type="button" onclick="cropReset()" title="Reset">
                    <i class="fas fa-sync-alt"></i>
                    <span>Reset</span>
                </button>
            </div>

            <p class="crop-preview-text">
                <i class="fas fa-info-circle"></i>
                Drag to move the image ‚Ä¢ Use corners to resize crop area
            </p>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImageCropper()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="applyCrop()">
                    <i class="fas fa-check"></i> Apply Crop
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Image Cropper -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<!-- Rest of js imports -->
<script src="{{ url_for('static', filename='badges.js') }}"></script>
<script src="{{ url_for('static', filename='discord.js') }}"></script>
<script src="{{ url_for('static', filename='teams-sidebar.js') }}"></script>
<script src="{{ url_for('static', filename='teams.js') }}"></script>
<script src="{{ url_for ('static', filename='profile-edit.js')}}"></script>
<script src="{{ url_for('static', filename='suspensions.js') }}"></script>
<script src="{{ url_for('static', filename='events.js') }}"></script>
<script src="{{ url_for('static', filename='admin-panel.js') }}"></script>
<script src="{{ url_for('static', filename='notifications.js') }}"></script>
<script src="{{ url_for('static', filename='game.js') }}"></script>
<script src="{{ url_for('static', filename='communities.js') }}"></script>
<script src="{{ url_for('static', filename='scheduled-events.js') }}"></script>
<script src="{{ url_for('static', filename='teamstats.js') }}"></script>
<script src="{{ url_for('static', filename='vods.js') }}"></script>
<script src="{{ url_for('static', filename='seasons.js') }}"></script>
<script src="{{ url_for('static', filename='leagues.js') }}"></script>
<!-- Must load second-to-last -->
<script src="{{ url_for('static', filename='modals.js') }}"></script>
<!-- Must load last -->
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>

<script>
    window.userPermissions = {
        is_admin: {{ 'true' if user.is_admin else 'false' }},
        is_gm: {{ 'true' if user.is_gm else 'false' }},
        is_developer: {{ 'true' if user.is_developer else 'false' }}
    };

    // Set global user context for events module
    window.currentUserId = {{ session.id }};

    // Events data for calendar
    const eventsDataFromServer = {{ events_by_date | tojson }};
</script>
{% endblock %}